# API и интеграции MVP Платформы для Предпринимателей

## 1. Общие принципы API

### 1.1. Архитектура API

REST API платформы спроектировано согласно следующим принципам:
- **Ресурсно-ориентированный подход** — API организовано вокруг ресурсов (пользователи, компании, запросы и т.д.)
- **Единообразие интерфейсов** — стандартные HTTP-методы для всех ресурсов
- **Stateless коммуникация** — сервер не хранит состояние клиента между запросами
- **HATEOAS** (Hypermedia as the Engine of Application State) — API предоставляет ссылки на связанные ресурсы

### 1.2. Формат данных

- Формат запросов и ответов: **JSON**
- Кодировка: **UTF-8**
- Стандарт дат: **ISO 8601** (например, `2025-05-15T14:30:00Z`)
- Формат ошибок: унифицированный объект с кодом, сообщением и деталями

### 1.3. Версионирование

- Версионирование API через URL: `/api/v1/...`
- Поддержка предыдущих версий API для обратной совместимости

### 1.4. Аутентификация и авторизация

- **Bearer Authentication** с использованием JWT-токенов
- Двухфакторная аутентификация для администраторов
- RBAC (Role-Based Access Control) для разграничения доступа

## 2. Основные эндпоинты REST API

### 2.1. Аутентификация

| Метод | Endpoint | Описание |
|-------|----------|----------|
| `POST` | `/api/v1/auth/register` | Регистрация нового пользователя |
| `POST` | `/api/v1/auth/login` | Авторизация пользователя |
| `POST` | `/api/v1/auth/refresh` | Обновление JWT-токена |
| `POST` | `/api/v1/auth/logout` | Выход из системы |
| `POST` | `/api/v1/auth/password/reset` | Запрос на сброс пароля |
| `PUT` | `/api/v1/auth/password/reset/:token` | Установка нового пароля |

### 2.2. Пользователи

| Метод | Endpoint | Описание |
|-------|----------|----------|
| `GET` | `/api/v1/users/me` | Получение данных текущего пользователя |
| `PUT` | `/api/v1/users/me` | Обновление данных текущего пользователя |
| `GET` | `/api/v1/users/:id` | Получение данных пользователя по ID |
| `PUT` | `/api/v1/users/:id` | Обновление данных пользователя (admin) |
| `DELETE` | `/api/v1/users/:id` | Удаление пользователя (admin) |

### 2.3. Компании

| Метод | Endpoint | Описание |
|-------|----------|----------|
| `POST` | `/api/v1/companies` | Создание новой компании |
| `GET` | `/api/v1/companies` | Получение списка компаний пользователя |
| `GET` | `/api/v1/companies/:id` | Получение данных компании по ID |
| `PUT` | `/api/v1/companies/:id` | Обновление данных компании |
| `DELETE` | `/api/v1/companies/:id` | Удаление компании |
| `POST` | `/api/v1/companies/:id/employees` | Добавление сотрудника в компанию |
| `GET` | `/api/v1/companies/:id/employees` | Получение списка сотрудников компании |
| `DELETE` | `/api/v1/companies/:id/employees/:userId` | Удаление сотрудника из компании |

### 2.4. Запросы на услуги

| Метод | Endpoint | Описание |
|-------|----------|----------|
| `POST` | `/api/v1/requests` | Создание нового запроса |
| `GET` | `/api/v1/requests` | Получение списка запросов пользователя |
| `GET` | `/api/v1/requests/:id` | Получение данных запроса по ID |
| `PUT` | `/api/v1/requests/:id` | Обновление данных запроса |
| `DELETE` | `/api/v1/requests/:id` | Удаление запроса |
| `PUT` | `/api/v1/requests/:id/status` | Изменение статуса запроса |
| `GET` | `/api/v1/requests/:id/history` | История изменений статуса запроса |

### 2.5. Чат

| Метод | Endpoint | Описание |
|-------|----------|----------|
| `GET` | `/api/v1/chats` | Получение списка чатов пользователя |
| `GET` | `/api/v1/chats/:id` | Получение данных чата по ID |
| `GET` | `/api/v1/chats/:id/messages` | Получение сообщений чата |
| `POST` | `/api/v1/chats/:id/messages` | Отправка сообщения в чат |
| `PUT` | `/api/v1/chats/:id/messages/:messageId/read` | Отметка сообщения как прочитанного |

### 2.6. Подрядчики

| Метод | Endpoint | Описание |
|-------|----------|----------|
| `GET` | `/api/v1/contractors` | Получение списка подрядчиков |
| `GET` | `/api/v1/contractors/:id` | Получение данных подрядчика по ID |
| `GET` | `/api/v1/contractors/categories` | Получение категорий подрядчиков |
| `GET` | `/api/v1/contractors/categories/:id` | Получение подрядчиков по категории |

### 2.7. Шаблоны документов

| Метод | Endpoint | Описание |
|-------|----------|----------|
| `GET` | `/api/v1/templates` | Получение списка шаблонов документов |
| `GET` | `/api/v1/templates/:id` | Получение данных шаблона по ID |
| `POST` | `/api/v1/templates/:id/generate` | Генерация документа на основе шаблона |
| `GET` | `/api/v1/templates/categories` | Получение категорий шаблонов |
| `GET` | `/api/v1/templates/categories/:id` | Получение шаблонов по категории |

### 2.8. Платежи

| Метод | Endpoint | Описание |
|-------|----------|----------|
| `GET` | `/api/v1/tariffs` | Получение списка тарифов |
| `GET` | `/api/v1/tariffs/:id` | Получение данных тарифа по ID |
| `POST` | `/api/v1/payments` | Создание платежа |
| `GET` | `/api/v1/payments/:id` | Получение данных платежа по ID |
| `GET` | `/api/v1/payments/history` | История платежей пользователя |
| `GET` | `/api/v1/subscriptions` | Получение подписок пользователя |
| `PUT` | `/api/v1/subscriptions/:id` | Изменение подписки |
| `DELETE` | `/api/v1/subscriptions/:id` | Отмена подписки |

### 2.9. Администрирование

| Метод | Endpoint | Описание |
|-------|----------|----------|
| `GET` | `/api/v1/admin/users` | Получение списка всех пользователей |
| `GET` | `/api/v1/admin/companies` | Получение списка всех компаний |
| `GET` | `/api/v1/admin/requests` | Получение списка всех запросов |
| `GET` | `/api/v1/admin/payments` | Получение списка всех платежей |
| `POST` | `/api/v1/admin/contractors` | Создание нового подрядчика |
| `PUT` | `/api/v1/admin/contractors/:id` | Обновление данных подрядчика |
| `DELETE` | `/api/v1/admin/contractors/:id` | Удаление подрядчика |
| `POST` | `/api/v1/admin/templates` | Добавление нового шаблона |
| `PUT` | `/api/v1/admin/templates/:id` | Обновление шаблона |
| `DELETE` | `/api/v1/admin/templates/:id` | Удаление шаблона |

## 3. Внешние API и интеграции

### 3.1. Интеграция с платежной системой Tinkoff Kassa

#### 3.1.1. Принцип работы
- Использование API Tinkoff Kassa для создания платежей
- Обработка уведомлений о статусе платежа через webhook
- Верификация платежей с использованием подписи
- Поддержка рекуррентных платежей для подписок

#### 3.1.2. Основные методы

| Метод | Описание |
|-------|----------|
| `Инициация платежа` | Создание платежа в системе Tinkoff |
| `Проверка статуса` | Запрос статуса платежа |
| `Возврат платежа` | Инициирование возврата средств |
| `Рекуррентный платеж` | Списание средств по сохраненной карте |
| `Webhook обработчик` | Обработка уведомлений о статусе платежа |

### 3.2. Интеграция с email-сервисом

#### 3.2.1. Принцип работы
- Использование SendGrid API для отправки email-уведомлений
- Шаблоны писем хранятся на стороне SendGrid
- Отслеживание доставки и открытия писем
- Обработка отказов от подписки

#### 3.2.2. Основные методы

| Метод | Описание |
|-------|----------|
| `Отправка уведомления` | Отправка разовых уведомлений |
| `Email-маркетинг` | Массовая рассылка маркетинговых материалов |
| `Транзакционные письма` | Отправка писем о регистрации, смене пароля и т.д. |
| `Сбор аналитики` | Отслеживание открытий и кликов |

### 3.3. Интеграция с SMS-сервисом (Twilio)

#### 3.3.1. Принцип работы
- Отправка SMS-уведомлений через API Twilio
- Поддержка двухфакторной аутентификации
- Отправка уведомлений о важных событиях

#### 3.3.2. Основные методы

| Метод | Описание |
|-------|----------|
| `Отправка SMS` | Отправка текстовых сообщений |
| `Верификация номера` | Подтверждение номера телефона |
| `Двухфакторная аутентификация` | Отправка кодов для 2FA |

## 4. WebSocket API

### 4.1. Принцип работы
- Использование Socket.IO для установления WebSocket соединения
- Аутентификация через JWT-токен
- Поддержка автоматического переподключения при обрыве соединения
- Fallback к HTTP Long Polling при невозможности установить WebSocket

### 4.2. События

| Событие | Направление | Описание |
|---------|-------------|----------|
| `auth` | Клиент → Сервер | Аутентификация в WebSocket соединении |
| `new_message` | Сервер → Клиент | Уведомление о новом сообщении в чате |
| `message_read` | Сервер → Клиент | Уведомление о прочтении сообщения |
| `status_changed` | Сервер → Клиент | Уведомление об изменении статуса запроса |
| `typing` | Клиент ↔ Сервер | Уведомление о печати сообщения |
| `join_room` | Клиент → Сервер | Присоединение к комнате чата |
| `leave_room` | Клиент → Сервер | Выход из комнаты чата |

## 5. Схема интеграций

```
                               ┌───────────────────┐
                               │                   │
                               │  MVP Платформа    │
                               │                   │
                               └─────────┬─────────┘
                                         │
          ┌───────────────────┬──────────┴────────┬────────────────────┐
          │                   │                   │                    │
┌─────────▼─────────┐ ┌───────▼───────┐ ┌─────────▼────────┐ ┌─────────▼─────────┐
│                   │ │               │ │                  │ │                   │
│  Tinkoff Kassa    │ │   SendGrid    │ │     Twilio       │ │      Sentry       │
│  (платежи)        │ │   (email)     │ │     (SMS)        │ │    (логирование)  │
│                   │ │               │ │                  │ │                   │
└───────────────────┘ └───────────────┘ └──────────────────┘ └───────────────────┘
```

## 6. Документация API

### 6.1. Swagger/OpenAPI
- Полная документация API доступна по адресу `/api/docs`
- Спецификация API соответствует стандарту OpenAPI 3.0
- Интерактивный интерфейс для тестирования API

### 6.2. Postman коллекция
- Доступна коллекция с примерами запросов для Postman
- Примеры включают все основные операции API
- Переменные окружения для тестирования на разных средах

## 7. Безопасность API

### 7.1. Меры защиты
- HTTPS для всех запросов
- Валидация входных данных
- Защита от CSRF-атак
- Ограничение частоты запросов (Rate Limiting)
- Проверка размера запросов
- Защита от SQL-инъекций через ORM
- Защита от XSS-атак

### 7.2. Обработка ошибок
- Унифицированный формат ответов с ошибками
- Логирование ошибок в Sentry
- Мониторинг подозрительной активности
- Обфускация чувствительных данных в логах 